#!/bin/sh

set -e

if [ "$1" != "-n" ]; then
    echo "Usage: $0 -n <nprocs> <command>"
    exit 1
fi
nprocs=$2
executable=$3
# Use LCT PMI File to bootstrap
export LCT_PMI_BACKEND=file
export LCT_PMI_FILE_NRANKS=${nprocs}

clean_up() {
  children=$(pidof ${executable})
  echo "Killing all children ${children}"
  if [ -n "${children}" ]; then
    kill ${children}
  fi
}

# Kill all children on exit or error
for sig in EXIT INT TERM; do
  trap clean_up $sig
done

# launch the command nprocs times nonblockingly
shift 2
for i in $(seq 1 ${nprocs}); do
  exec $@ &
done
wait # wait for all background jobs to finish
